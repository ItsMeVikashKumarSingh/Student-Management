<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Students - Student Management</title>
    <link rel="stylesheet" href="/css/shared.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/ag-grid-community@34.1.2/dist/ag-grid-community.min.js"></script>
    <script src="/js/shared.js"></script>
    <script>
        const DEFAULT_IMG = '/images/default_profile_pic.jpg';

        $(document).ready(function() {
            fetchRole(function() {
                toggleAdminBits();
                loadStudents();
            });

            $('#studentForm').on('submit', function(e) {
                e.preventDefault();
                saveStudent();
            });

            $('#studentProfile').on('change', function() {
                const f = this.files[0];
                if (f) {
                    const reader = new FileReader();
                    reader.onload = e => $('#studentPreview').attr('src', e.target.result).show();
                    reader.readAsDataURL(f);
                    $('#removeImage').show();
                    window.removePicture = false;
                }
                refreshClearButton();
            });

            $('#removeImage').on('click', function() {
                $('#studentProfile').val('');
                $('#studentPreview').attr('src', '').hide();
                $('#removeImage').hide();
                window.removePicture = true;
                refreshClearButton();
            });

            // Dynamic Clear button
            $('#studentName, #studentEmail, #studentAge, #studentCourseName').on('input change', refreshClearButton);
            $('#clearBtn').on('click', resetForm);
            refreshClearButton(); // Initial check
        });

        function isFormDirty() {
            return $('#studentName').val().trim() !== '' ||
                $('#studentEmail').val().trim() !== '' ||
                $('#studentAge').val() !== '' ||
                $('#studentCourseName').val().trim() !== '' ||
                $('#studentProfile')[0].files.length > 0;
        }

        function refreshClearButton() {
            if (isFormDirty()) {
                $('#clearBtn').show();
            } else {
                $('#clearBtn').hide();
            }
        }

        function toggleAdminBits() {
            if (window.currentRole === 'ADMIN') {
                $('#insertBlock').removeClass('d-none');
                setupCourseAutocomplete('#studentCourseName', '#studentCourseId');
            } else {
                $('#insertBlock').addClass('d-none');
            }
            $('#pageTitle').text((window.currentRole === 'ADMIN' ? 'Manage' : 'View') + ' Students');
        }

        function saveStudent() {
            const fd = new FormData();
            const roll = $('#studentRoll').val();
            if (roll) fd.append('roll', roll);
            fd.append('name', $('#studentName').val().trim());
            fd.append('email', $('#studentEmail').val().trim());
            fd.append('age', $('#studentAge').val());
            fd.append('courseId', $('#studentCourseId').val());
            const file = $('#studentProfile')[0].files[0];
            if (file) fd.append('profilePicture', file);
            if (window.removePicture) fd.append('removePicture', 'true');

            const url = roll ? '/students/update' : '/students/add';
            const method = roll ? 'PUT' : 'POST';

            $.ajax({
                url, method, data: fd, processData: false, contentType: false,
                success: () => { resetForm(); loadStudents(); },
                error: err => {
                    console.error('Student save error:', err);
                    alert(err.responseText || 'Server error');
                }
            });
        }

        function loadStudents() {
            $.get('/students/all', rows => {
                const rowData = rows.map(r => ({
                    roll: r[0], name: r[1], email: r[2], age: r[3],
                    course_name: r[4], courseId: r[5], profile_picture_name: r[6]
                }));

                const cols = [
                    {headerName:'Avatar', width:90, pinned:'left',
                        cellRenderer: p => {
                            const file = p.data.profile_picture_name;
                            const src = file ? `/image/StudentPic/${file}` : DEFAULT_IMG;
                            const img = document.createElement('img');
                            img.src = src;
                            img.alt = 'avatar';
                            img.style = 'width:36px; height:36px; border-radius:50%; object-fit:cover;';
                            return img;
                        }},
                    {headerName:'Roll', field:'roll', width:110, filter:'agNumberColumnFilter'},
                    {headerName:'Name', field:'name', flex:1, filter:'agTextColumnFilter'},
                    {headerName:'Email', field:'email', flex:1, filter:'agTextColumnFilter'},
                    {headerName:'Age', field:'age', width:110, filter:'agNumberColumnFilter'},
                    {headerName:'Course', field:'course_name', flex:1, filter:'agTextColumnFilter'}
                ];

                if (window.currentRole === 'ADMIN') {
                    cols.push({
                        headerName:'Documents', minWidth:160, pinned:'right',
                        cellRenderer: p => {
                            const wrap = document.createElement('span');
                            const dBtn = $('<button class="btn btn-sm btn-outline-secondary">View Docs</button>').on('click', () => {
                                const name = encodeURIComponent(p.data.name);
                                window.location.href = `/documents.html?roll=${p.data.roll}&name=${name}`;
                            });
                            wrap.appendChild(dBtn[0]);
                            return wrap;
                        }
                    });
                    cols.push({
                        headerName:'Actions', minWidth:170, pinned:'right',
                        cellRenderer: p => {
                            const wrap = document.createElement('span');
                            const eBtn = $('<button class="btn btn-sm btn-outline-primary me-2">Edit</button>').on('click', () => editRow(p.data));
                            const dBtn = $('<button class="btn btn-sm btn-outline-danger">Delete</button>').on('click', () => delRow(p.data.roll));
                            wrap.appendChild(eBtn[0]); wrap.appendChild(dBtn[0]);
                            return wrap;
                        }
                    });
                }

                const gridDiv = document.getElementById('studentGrid');
                gridDiv.innerHTML = '';
                agGrid.createGrid(gridDiv, {
                    columnDefs: cols,
                    rowData,
                    defaultColDef: {sortable: true, resizable: true, filter: true},
                    rowHeight: 44, headerHeight: 58,
                    onFirstDataRendered: e => e.api.sizeColumnsToFit()
                });
            }).fail(() => alert('Failed to load students data.'));
        }

        function editRow(row) {
            $('#studentRoll').val(row.roll);
            $('#studentName').val(row.name);
            $('#studentEmail').val(row.email);
            $('#studentAge').val(row.age);
            $('#studentCourseName').val(row.course_name);
            $('#studentCourseId').val(row.courseId);

            if (row.profile_picture_name) {
                $('#studentPreview').attr('src', `/image/StudentPic/${row.profile_picture_name}`).show();
                $('#removeImage').show();
            } else {
                $('#studentPreview').attr('src', '').hide();
                $('#removeImage').hide();
            }

            $('#studentSubmitBtn').text('Update Student');
            window.scrollTo({top: 0, behavior: 'smooth'});
            window.removePicture = false;
            refreshClearButton();
        }

        function delRow(id) {
            if (!confirm('Delete this student?')) return;
            $.ajax({
                url: `/students/delete/${id}`, method: 'DELETE',
                success: () => loadStudents(),
                error: err => alert(err.responseText || 'Delete failed')
            });
        }

        function resetForm() {
            $('#studentForm')[0].reset();
            $('#studentRoll').val('');
            $('#studentCourseId').val('');
            $('#studentPreview').attr('src', '').hide();
            $('#removeImage').hide();
            $('#studentSubmitBtn').text('Add Student');
            window.removePicture = false;
            refreshClearButton();
        }
    </script>
</head>
<body>
<nav>
    <ul>
        <li><a href="/dashboard.html">Dashboard</a></li>
        <li><a href="/students.html">Students</a></li>
        <li><a href="/teachers.html">Teachers</a></li>
        <li><a href="/courses.html">Courses</a></li>
        <li><a href="#" onclick="logout()">Logout</a></li>
    </ul>
</nav>
<main>
    <h2 id="pageTitle" class="mb-4">Manage Students</h2>
    <section id="insertBlock" class="d-none mb-4">
        <form id="studentForm" class="p-3 border rounded bg-white shadow-sm">
            <div class="mb-3 text-center">
                <img id="studentPreview" src="" alt="Preview" style="width:80px;height:80px;border-radius:50%;object-fit:cover;display:none;">
                <button type="button" id="removeImage" style="display:none; background:red; color:white; border:none; border-radius:50%; position:relative; top:-20px; left:-30px;">X</button>
            </div>
            <div class="mb-3">
                <label class="form-label">Profile Picture (JPG/PNG, ≤ 5 MB, optional)</label>
                <input id="studentProfile" type="file" class="form-control" accept="image/jpeg,image/png">
            </div>
            <div class="row g-3">
                <div class="col-md-6">
                    <label class="form-label">Name *</label>
                    <input id="studentName" type="text" class="form-control" placeholder="Full name" required>
                </div>
                <div class="col-md-6">
                    <label class="form-label">Email *</label>
                    <input id="studentEmail" type="email" class="form-control" placeholder="email@site.com" required>
                </div>
                <div class="col-md-3">
                    <label class="form-label">Age *</label>
                    <input id="studentAge" type="number" class="form-control" min="1" placeholder="e.g., 20" required>
                </div>
                <div class="col-md-9">
                    <label class="form-label">Course *</label>
                    <input id="studentCourseName" type="text" class="form-control" placeholder="Type to search course" required>
                    <input id="studentCourseId" type="hidden">
                    <small class="form-text text-muted">Select from suggestions or type to match.</small>
                </div>
            </div>
            <input id="studentRoll" type="hidden">
            <div class="mt-3">
                <button id="studentSubmitBtn" class="btn btn-primary me-2" type="submit">Add Student</button>
                <button type="button" id="clearBtn" class="btn btn-secondary" style="display:none">Clear</button>
            </div>
        </form>
    </section>
    <div id="studentGrid" class="ag-theme-alpine" style="height: 500px; width: 100%;"></div>
</main>
<footer>© 2025 Student Management System</footer>
</body>
</html>
