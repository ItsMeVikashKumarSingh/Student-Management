<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Students · Student Management</title>
    <!-- Styles -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="/css/shared.css">
    <style>
        /* Custom styles for datalist suggestions */
        datalist {
            position: absolute;
            background-color: #f8f9fa; /* Light background */
            border: 1px solid #ced4da; /* Border to match Bootstrap */
            border-top: none;
            max-height: 200px;
            overflow-y: auto;
            width: 100%; /* Match input width */
            z-index: 1000; /* Ensure it overlays */
        }
        datalist option {
            padding: 8px 12px; /* Padding for better touch */
            color: #007bff; /* Blue text for distinction */
            cursor: pointer;
            font-style: italic; /* Italic to look different */
        }
        datalist option:hover,
        datalist option:focus {
            background-color: #e9ecef; /* Hover background */
            color: #0056b3; /* Darker blue on hover */
        }
    </style>
    <!-- Scripts -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/ag-grid-community@34.1.2/dist/ag-grid-community.min.js"></script>
    <script src="/js/shared.js"></script>
    <script>
        /* ---------- PAGE BOOT ---------- */
        $(document).ready(() => {
            fetchRole(() => {
                toggleAdminBits();
                loadStudents();
            });
            $('#studentForm').on('submit', e => { e.preventDefault(); saveStudent(); });
        });
        /* ---------- UI HELPERS ---------- */
        function toggleAdminBits () {
            // show form only for admins
            if (window.currentRole === 'ADMIN') {
                $('#insertBlock').removeClass('d-none');
                setupCourseAutocomplete('#studentCourseName', '#studentCourseId');
            } else {
                $('#insertBlock').addClass('d-none');
            }
            // title
            $('#pageTitle').text(window.currentRole === 'ADMIN' ? 'Manage Students' : 'View Students');
        }
        function resetForm () {
            $('#studentForm')[0].reset();
            $('#studentRoll').val('');
            $('#studentCourseId').val('');
            $('#studentSubmitBtn').text('Add Student');
        }
        /* ---------- CRUD CALLS ---------- */
        function saveStudent () {
            const data = {
                roll:   $('#studentRoll').val(),
                name:   $('#studentName').val().trim(),
                email:  $('#studentEmail').val().trim(),
                age:    $('#studentAge').val(),
                courseId: $('#studentCourseId').val()
            };
            /* improved validation */
            if (!data.name || !data.email || !data.age) {
                alert('Name, email, and age are required');
                return;
            }
            if (!data.courseId) {
                alert('Please select a valid course from the suggestions');
                return;
            }
            $.ajax({
                url:        data.roll ? '/students/update' : '/students/add',
                method:     data.roll ? 'PUT' : 'POST',
                contentType:'application/json',
                data:       JSON.stringify(data),
                success:    () => { resetForm(); loadStudents(); },
                error:      err => alert(err.responseText || 'Server error')
            });
        }
        function loadStudents () {
            $.get('/students/all', rows => {
                const rowData = rows.map(r => ({
                    roll:   r[0], name: r[1], email: r[2], age: r[3], course_name: r[4], courseId: r[5]
                }));
                const cols = [
                    {headerName:'Roll',   field:'roll', width:110, filter:'agNumberColumnFilter'},
                    {headerName:'Name',   field:'name', flex:1, filter:'agTextColumnFilter'},
                    {headerName:'Email',  field:'email', flex:1, filter:'agTextColumnFilter'},
                    {headerName:'Age',    field:'age',  width:110, filter:'agNumberColumnFilter'},
                    {headerName:'Course', field:'course_name', flex:1, filter:'agTextColumnFilter'}
                ];
                /* action buttons for admins */
                if (window.currentRole === 'ADMIN') cols.push({
                    headerName:'Actions',
                    minWidth:170, pinned:'right',
                    cellRenderer: p => {
                        const wrap = document.createElement('span');
                        const eBtn = $('<button class="btn btn-sm btn-outline-primary me-2">Edit</button>')
                            .on('click', () => editRow(p.data));
                        const dBtn = $('<button class="btn btn-sm btn-outline-danger">Delete</button>')
                            .on('click', () => delRow(p.data.roll));
                        wrap.appendChild(eBtn[0]); wrap.appendChild(dBtn[0]);
                        return wrap;
                    }
                });
                const gridDiv = document.getElementById('studentGrid');
                gridDiv.innerHTML = '';                    // clear previous grid
                agGrid.createGrid(gridDiv, {
                    columnDefs: cols,
                    rowData,
                    defaultColDef:{sortable:true,resizable:true,filter:true},
                    rowHeight:44, headerHeight:58,
                    onFirstDataRendered:e=>e.api.sizeColumnsToFit()
                });
            });
        }
        function editRow (row) {
            $('#studentRoll').val(row.roll);
            $('#studentName').val(row.name);
            $('#studentEmail').val(row.email);
            $('#studentAge').val(row.age);
            $('#studentCourseName').val(row.course_name);
            $('#studentCourseId').val(row.courseId);
            $('#studentSubmitBtn').text('Update Student');
            window.scrollTo({top:0,behavior:'smooth'});
        }
        function delRow (id) {
            if (!confirm('Delete this student?')) return;
            $.ajax({
                url:`/students/delete/${id}`, method:'DELETE',
                success:() => loadStudents(),
                error:err => alert(err.responseText || 'Delete failed')
            });
        }
    </script>
</head>
<body>
<!-- NAV -->
<nav>
    <ul>
        <li><a href="/dashboard.html">Dashboard</a></li>
        <li><a href="/students.html">Students</a></li>
        <li><a href="/teachers.html">Teachers</a></li>
        <li><a href="/courses.html">Courses</a></li>
        <li><a href="#" onclick="logout()">Logout</a></li>
    </ul>
</nav>
<!-- MAIN -->
<main>
    <h2 id="pageTitle" class="mb-4">Manage Students</h2>
    <!-- INSERT / UPDATE FORM (hidden for users) -->
    <section id="insertBlock" class="d-none mb-4">
        <form id="studentForm" class="p-3 border rounded bg-white shadow-sm">
            <div class="row g-3">
                <div class="col-md-6">
                    <label class="form-label">Name *</label>
                    <input id="studentName" type="text" class="form-control" placeholder="Full name" required>
                </div>
                <div class="col-md-6">
                    <label class="form-label">Email *</label>
                    <input id="studentEmail" type="email" class="form-control" placeholder="email@site.com" required>
                </div>
                <div class="col-md-3">
                    <label class="form-label">Age *</label>
                    <input id="studentAge" type="number" class="form-control" min="1" placeholder="e.g., 20" required>
                </div>
                <div class="col-md-9">
                    <label class="form-label">Course *</label>
                    <input id="studentCourseName" type="text" class="form-control" placeholder="Type to search course" required>
                    <input id="studentCourseId" type="hidden">
                    <small class="form-text text-muted">Select from suggestions or type to match.</small>
                </div>
            </div>
            <input id="studentRoll" type="hidden">
            <div class="mt-3">
                <button id="studentSubmitBtn" class="btn btn-primary me-2" type="submit">Add Student</button>
                <button type="button" class="btn btn-secondary" onclick="resetForm()">Cancel</button>
            </div>
        </form>
    </section>
    <!-- GRID -->
    <div id="studentGrid" class="ag-theme-alpine"></div>
</main>
<!-- Add this dialog HTML inside <body> (e.g., after <main>) in students.html, teachers.html, and courses.html -->
<div id="validationAlert" class="alert alert-danger alert-dismissible fade show" role="alert" style="display: none; position: fixed; top: 20px; right: 20px; z-index: 1050;">
    <strong>Error:</strong> <span id="validationAlertMessage"></span>
    <button type="button" class="btn-close" id="validationAlertClose" aria-label="Close"></button>
</div>
<footer>© 2025 Student Management System</footer>
</body>
</html>
