<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Login - Student Management System</title>
    <link rel="stylesheet" href="/css/shared.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .login-container {
            max-width: 450px;
            width: 100%;
            margin: 20px;
            background: white;
            border-radius: 15px;
            box-shadow: 0 15px 35px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        .login-header {
            background: linear-gradient(135deg, #007bff, #0056b3);
            color: white;
            padding: 40px 30px;
            text-align: center;
        }
        .login-form {
            padding: 40px 30px;
        }
        .form-control {
            border: 2px solid #e1e5e9;
            border-radius: 10px;
            padding: 15px 50px 15px 15px;
            font-size: 16px;
            transition: all 0.3s ease;
        }
        .form-control:focus {
            border-color: #007bff;
            box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
        }
        .input-icon {
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: #6c757d;
        }
        .btn-login {
            width: 100%;
            padding: 15px;
            font-size: 16px;
            font-weight: 500;
            border-radius: 10px;
            background: linear-gradient(135deg, #007bff, #0056b3);
            border: none;
            color: white;
            transition: all 0.3s ease;
        }
        .btn-login:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 123, 255, 0.4);
        }
        .alert-custom {
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
            border: none;
        }
        .alert-error {
            background: #fee;
            color: #d63384;
        }
        .alert-warning {
            background: #fff3cd;
            color: #856404;
        }
        .alert-success {
            background: #d1e7dd;
            color: #0a3622;
        }
        .form-group {
            margin-bottom: 25px;
            position: relative;
        }
        .loading-spinner {
            width: 20px;
            height: 20px;
            margin-right: 10px;
        }
    </style>
</head>
<body>
<div class="login-container">
    <div class="login-header">
        <h2><i class="fas fa-graduation-cap"></i> Student Management</h2>
        <p>Welcome back! Please sign in to your account</p>
    </div>

    <div class="login-form">
        <div id="alertContainer"></div>

        <form id="unifiedLoginForm">
            <div class="form-group">
                <input type="text" class="form-control" id="username"
                       placeholder="Email address or Username" required>
                <i class="fas fa-user input-icon"></i>
            </div>

            <div class="form-group">
                <input type="password" class="form-control" id="password"
                       placeholder="Password" required>
                <i class="fas fa-lock input-icon"></i>
            </div>

            <button type="submit" class="btn btn-login" id="loginBtn">
                <span id="loginBtnText">Sign In</span>
                <span id="loginSpinner" class="spinner-border spinner-border-sm loading-spinner d-none"
                      role="status"></span>
            </button>
        </form>
    </div>
</div>

<script>
    $(document).ready(function() {
        $('#unifiedLoginForm').on('submit', function(e) {
            e.preventDefault();

            const username = $('#username').val().trim();
            const password = $('#password').val().trim();

            if (!username || !password) {
                showAlert('Please enter both username/email and password', 'error');
                return;
            }

            authenticateUser(username, password);
        });
    });

    function authenticateUser(username, password) {
        setLoadingState(true);
        clearAlerts();

        $.ajax({
            url: '/auth/authenticate',
            method: 'POST',
            data: {
                username: username,
                password: password
            },
            success: function(response) {
                console.log('Login response:', response);

                if (response.success) {
                    handleSuccessfulLogin(response);
                } else {
                    handleAuthError(response);
                }
            },
            error: function(xhr) {
                console.error('Login error:', xhr.responseText);
                showAlert('Server error. Please try again.', 'error');
            },
            complete: function() {
                setLoadingState(false);
            }
        });
    }

    function handleSuccessfulLogin(response) {
        // Show correct success message based on user type
        let message = response.message || 'Login successful!';

        if (response.userType === 'ADMIN') {
            showAlert(message + ' Redirecting to Admin Dashboard...', 'success');
        } else if (response.userType === 'USER') {
            showAlert(message + ' Redirecting to User Dashboard...', 'success');
        } else if (response.userType === 'TEACHER') {
            showAlert(message + ' Redirecting to Teacher Dashboard...', 'success');

            // Store teacher data for teacher dashboard
            if (response.user) {
                sessionStorage.setItem('teacherData', JSON.stringify(response.user));
            }
        }

        // **CRITICAL FIX: Force redirect after showing message**
        setTimeout(() => {
            console.log('Redirecting to:', response.redirectUrl);
            window.location.href = response.redirectUrl;
        }, 1500);
    }

    function handleAuthError(response) {
        if (response.userNotFound) {
            showAlert(
                '<strong>Account Not Found</strong><br>' +
                response.message + '<br>' +
                '<small>' + response.suggestion + '</small>',
                'warning'
            );
        } else if (response.wrongPassword) {
            showAlert(
                '<strong>Incorrect Password</strong><br>' +
                response.message + '<br>' +
                '<small>' + response.suggestion + '</small>',
                'error'
            );
        } else {
            showAlert(response.message || 'Login failed. Please try again.', 'error');
        }
    }

    function showAlert(message, type) {
        let alertClass = 'alert-error';
        let icon = 'fas fa-exclamation-circle';

        switch(type) {
            case 'success':
                alertClass = 'alert-success';
                icon = 'fas fa-check-circle';
                break;
            case 'warning':
                alertClass = 'alert-warning';
                icon = 'fas fa-exclamation-triangle';
                break;
        }

        $('#alertContainer').html(`<div class="alert-custom ${alertClass}"><i class="${icon}"></i> ${message}</div>`);
    }

    function clearAlerts() {
        $('#alertContainer').empty();
    }

    function setLoadingState(loading) {
        if (loading) {
            $('#loginBtnText').text('Signing In...');
            $('#loginSpinner').removeClass('d-none');
            $('#loginBtn').prop('disabled', true);
        } else {
            $('#loginBtnText').text('Sign In');
            $('#loginSpinner').addClass('d-none');
            $('#loginBtn').prop('disabled', false);
        }
    }
</script>

</body>
</html>
