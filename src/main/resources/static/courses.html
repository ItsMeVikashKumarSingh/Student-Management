<!-- courses.html -->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Courses - Student Management</title>
    <link rel="stylesheet" href="/css/shared.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/ag-grid-community@34.1.2/dist/ag-grid-community.min.js"></script>
    <script src="/js/shared.js"></script>
    <script>
        $(document).ready(function() {
            fetchRole(function() {
                toggleAdminBits();
                loadCourses();
            });
            $('#courseForm').on('submit', function(e) {
                e.preventDefault();
                if (validateForm([{id: '#courseName', name: 'Course Name'}])) saveCourse();
            });
        });

        function toggleAdminBits() {
            if (window.currentRole === 'ADMIN') $('#insertBlock').removeClass('d-none');
            else $('#insertBlock').addClass('d-none');
            $('#pageTitle').text((window.currentRole === 'ADMIN' ? 'Manage' : 'View') + ' Courses');
        }

        function saveCourse () {
            const id = $('#courseId').val();
            const data = {
                id: id,
                name: $('#courseName').val().trim(),
                description: $('#courseDescription').val().trim()
            };
            const url = id ? '/courses/update' : '/courses/add';
            const method = id ? 'PUT' : 'POST';
            $.ajax({
                url, method,
                contentType: 'application/json',
                data: JSON.stringify(data),
                success: () => { resetForm(); loadCourses(); },
                error: err => alert(err.responseText || 'Server error')
            });
        }

        function loadCourses () {
            $.get('/courses/all', rows => {
                const rowData = rows.map(r => ({ id: r[0], name: r[1], description: r[2] }));
                const cols = [
                    {headerName:'ID', field:'id', width:110, filter:'agNumberColumnFilter'},
                    {headerName:'Name', field:'name', flex:1, filter:'agTextColumnFilter'},
                    {headerName:'Description', field:'description', flex:1, filter:'agTextColumnFilter'}
                ];
                if (window.currentRole === 'ADMIN') cols.push({
                    headerName:'Actions', minWidth:170, pinned:'right',
                    cellRenderer: p => {
                        const wrap = document.createElement('span');
                        const eBtn = $('<button class="btn btn-sm btn-outline-primary me-2">Edit</button>').on('click', () => editRow(p.data));
                        const dBtn = $('<button class="btn btn-sm btn-outline-danger">Delete</button>').on('click', () => delRow(p.data.id));
                        wrap.appendChild(eBtn[0]); wrap.appendChild(dBtn[0]);
                        return wrap;
                    }
                });
                const gridDiv = document.getElementById('courseGrid');
                gridDiv.innerHTML = '';
                agGrid.createGrid(gridDiv, {
                    columnDefs: cols,
                    rowData,
                    defaultColDef:{sortable:true,resizable:true,filter:true},
                    rowHeight:44, headerHeight:58,
                    onFirstDataRendered:e=>e.api.sizeColumnsToFit()
                });
            }).fail(() => alert('Failed to load courses data.'));
        }

        function editRow (row) {
            $('#courseId').val(row.id);
            $('#courseName').val(row.name);
            $('#courseDescription').val(row.description);
            $('#courseSubmitBtn').text('Update Course');
            window.scrollTo({top:0,behavior:'smooth'});
        }

        function delRow (id) {
            if (!confirm('Delete this course?')) return;
            $.ajax({
                url:`/courses/delete/${id}`, method:'DELETE',
                success:() => loadCourses(),
                error:err => alert(err.responseText || 'Delete failed')
            });
        }

        function resetForm () {
            $('#courseForm')[0].reset();
            $('#courseId').val('');
            $('#courseSubmitBtn').text('Add Course');
        }
    </script>
</head>
<body>
<nav>
    <ul>
        <li><a href="/dashboard.html">Dashboard</a></li>
        <li><a href="/students.html">Students</a></li>
        <li><a href="/teachers.html">Teachers</a></li>
        <li><a href="/courses.html">Courses</a></li>
        <li><a href="#" onclick="logout()">Logout</a></li>
    </ul>
</nav>
<main>
    <h2 id="pageTitle" class="mb-4">Manage Courses</h2>
    <section id="insertBlock" class="d-none mb-4">
        <form id="courseForm" class="p-3 border rounded bg-white shadow-sm">
            <div class="mb-3">
                <label class="form-label">Name *</label>
                <input id="courseName" type="text" class="form-control" placeholder="Course name" required>
            </div>
            <div class="mb-3">
                <label class="form-label">Description</label>
                <input id="courseDescription" type="text" class="form-control" placeholder="Course description">
            </div>
            <input id="courseId" type="hidden">
            <div class="mt-3">
                <button id="courseSubmitBtn" class="btn btn-primary me-2" type="submit">Add Course</button>
                <button type="button" class="btn btn-secondary" onclick="resetForm()">Cancel</button>
            </div>
        </form>
    </section>
    <div id="courseGrid" class="ag-theme-alpine" style="height: 500px; width: 100%;"></div>
</main>
<footer>Â© 2025 Student Management System</footer>
</body>
</html>
