<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Teachers - Student Management</title>
    <link rel="stylesheet" href="/css/shared.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/ag-grid-community@34.1.2/dist/ag-grid-community.min.js"></script>
    <script src="/js/shared.js"></script>
    <script>
        const DEFAULT_IMG = '/images/default_profile_pic.jpg';
        $(document).ready(function() {
            console.log('Teachers page loaded successfully');

            fetchRole(function() {
                toggleAdminBits();
                loadTeachers();
            });

            $('#teacherForm').on('submit', function(e) {
                e.preventDefault();
                console.log('Form submitted');
                saveTeacher();
            });

            $('#teacherProfile').on('change', function() {
                const f = this.files[0];
                if (f) {
                    console.log('Profile picture selected:', f.name);
                    const reader = new FileReader();
                    reader.onload = e => $('#teacherPreview').attr('src', e.target.result).show();
                    reader.readAsDataURL(f);
                    $('#removeImage').show();
                    window.removePicture = false;
                }
            });

            $('#removeImage').on('click', function() {
                console.log('Remove image clicked');
                $('#teacherProfile').val('');
                $('#teacherPreview').attr('src', '').hide();
                $('#removeImage').hide();
                window.removePicture = true;
            });

            // Generate password button handler
            $('#generatePasswordBtn').on('click', function() {
                console.log('Generate password clicked');
                generatePassword();
            });
        });

        function toggleAdminBits() {
            if (window.currentRole === 'ADMIN') {
                $('#insertBlock').removeClass('d-none');
                setupCourseAutocomplete('#teacherCourseName', '#teacherCourseId');
            } else {
                $('#insertBlock').addClass('d-none');
            }
            $('#pageTitle').text((window.currentRole === 'ADMIN' ? 'Manage' : 'View') + ' Teachers');
        }

        function saveTeacher() {
            console.log('=== SAVE TEACHER FUNCTION START ===');

            // Get all form values
            const id = $('#teacherId').val();
            const name = $('#teacherName').val().trim();
            const email = $('#teacherEmail').val().trim();
            const courseId = $('#teacherCourseId').val();
            const password = $('#teacherPassword').val().trim();
            const profileFile = $('#teacherProfile')[0].files[0];

            // Debug logging
            console.log('Form values collected:', {
                id: id,
                name: name,
                email: email,
                courseId: courseId,
                password: password ? '***masked***' : '(empty)',
                hasProfileFile: !!profileFile,
                removePicture: window.removePicture
            });

            // Validation for new teachers
            if (!id && !password) {
                console.error('Validation failed: Password required for new teacher');
                alert('Password is required when creating a new teacher!');
                return;
            }

            // Additional validations
            if (!name) {
                alert('Teacher name is required!');
                return;
            }

            if (!email) {
                alert('Teacher email is required!');
                return;
            }

            if (!courseId) {
                alert('Please select a course!');
                return;
            }

            // Create FormData
            const fd = new FormData();

            // Add form fields
            if (id) {
                fd.append('id', id);
                console.log('Added ID to FormData:', id);
            }

            fd.append('name', name);
            fd.append('email', email);
            fd.append('courseId', courseId);
            fd.append('password', password); // Always send password (even if empty)

            console.log('Added basic fields to FormData');

            // Add profile picture if selected
            if (profileFile) {
                fd.append('profilePicture', profileFile);
                console.log('Added profile picture to FormData:', profileFile.name);
            }

            // Add remove picture flag
            if (window.removePicture) {
                fd.append('removePicture', 'true');
                console.log('Added removePicture flag to FormData');
            }

            // Determine URL and method
            const url = id ? '/teachers/update' : '/teachers/add';
            const method = id ? 'PUT' : 'POST';

            console.log('Making AJAX request:', { url, method });

            // Log FormData contents (for debugging)
            console.log('FormData contents:');
            for (let [key, value] of fd.entries()) {
                if (key === 'password') {
                    console.log(`  ${key}: ***masked***`);
                } else if (key === 'profilePicture') {
                    console.log(`  ${key}: [File: ${value.name}]`);
                } else {
                    console.log(`  ${key}: ${value}`);
                }
            }

            // Make AJAX request
            $.ajax({
                url: url,
                method: method,
                data: fd,
                processData: false,
                contentType: false,
                beforeSend: function() {
                    console.log('AJAX request started');
                    // Disable submit button to prevent double submission
                    $('#teacherSubmitBtn').prop('disabled', true).text('Saving...');
                },
                success: function(response) {
                    console.log('AJAX success:', response);
                    alert('Teacher saved successfully!');
                    resetForm();
                    loadTeachers();
                },
                error: function(xhr, status, error) {
                    console.error('AJAX error:', {
                        status: xhr.status,
                        statusText: xhr.statusText,
                        responseText: xhr.responseText,
                        error: error
                    });

                    let errorMessage = 'Failed to save teacher. ';
                    if (xhr.responseText) {
                        try {
                            const errorResponse = JSON.parse(xhr.responseText);
                            errorMessage += errorResponse.message || errorResponse.error || xhr.responseText;
                        } catch (e) {
                            errorMessage += xhr.responseText;
                        }
                    } else {
                        errorMessage += `Server returned ${xhr.status} ${xhr.statusText}`;
                    }

                    alert(errorMessage);
                },
                complete: function() {
                    console.log('AJAX request completed');
                    // Re-enable submit button
                    $('#teacherSubmitBtn').prop('disabled', false);
                    const isUpdate = $('#teacherId').val();
                    $('#teacherSubmitBtn').text(isUpdate ? 'Update Teacher' : 'Add Teacher');
                }
            });

            console.log('=== SAVE TEACHER FUNCTION END ===');
        }

        function loadTeachers() {
            console.log('Loading teachers...');
            $.get('/teachers/all', rows => {
                console.log('Teachers loaded:', rows.length, 'records');
                const rowData = rows.map(r => ({
                    id: r[0], name: r[1], email: r[2], course_name: r[3], courseId: r[4], profile_picture_name: r[5]
                }));
                const cols = [
                    {headerName:'Avatar', width:90, pinned:'left',
                        cellRenderer: p => {
                            const file = p.data.profile_picture_name;
                            const src = file ? `/image/TeacherPic/${file}` : DEFAULT_IMG;
                            const img = document.createElement('img');
                            img.src = src;
                            img.alt = 'avatar';
                            img.style = 'width:36px; height:36px; border-radius:50%; object-fit:cover;';
                            return img;
                        }},
                    {headerName:'ID', field:'id', width:110, filter:'agNumberColumnFilter'},
                    {headerName:'Name', field:'name', flex:1, filter:'agTextColumnFilter'},
                    {headerName:'Email', field:'email', flex:1, filter:'agTextColumnFilter'},
                    {headerName:'Course', field:'course_name', flex:1, filter:'agTextColumnFilter'}
                ];
                if (window.currentRole === 'ADMIN') cols.push({
                    headerName:'Actions', minWidth:170, pinned:'right',
                    cellRenderer: p => {
                        const wrap = document.createElement('span');
                        const eBtn = $('<button class="btn btn-sm btn-outline-primary me-2">Edit</button>').on('click', () => editRow(p.data));
                        const dBtn = $('<button class="btn btn-sm btn-outline-danger">Delete</button>').on('click', () => delRow(p.data.id));
                        wrap.appendChild(eBtn[0]); wrap.appendChild(dBtn[0]);
                        return wrap;
                    }
                });
                const gridDiv = document.getElementById('teacherGrid');
                gridDiv.innerHTML = '';
                agGrid.createGrid(gridDiv, {
                    columnDefs: cols,
                    rowData,
                    defaultColDef: {sortable: true, resizable: true, filter: true},
                    rowHeight: 44, headerHeight: 58,
                    onFirstDataRendered: e => e.api.sizeColumnsToFit()
                });
            }).fail((xhr) => {
                console.error('Failed to load teachers:', xhr);
                alert('Failed to load teachers data.');
            });
        }

        function editRow(row) {
            console.log('Editing teacher:', row);
            $('#teacherId').val(row.id);
            $('#teacherName').val(row.name);
            $('#teacherEmail').val(row.email);
            $('#teacherCourseName').val(row.course_name);
            $('#teacherCourseId').val(row.courseId);
            $('#teacherPassword').val(''); // Clear password field for security

            if (row.profile_picture_name) {
                $('#teacherPreview').attr('src', `/image/TeacherPic/${row.profile_picture_name}`).show();
                $('#removeImage').show();
            } else {
                $('#teacherPreview').attr('src', '').hide();
                $('#removeImage').hide();
            }

            $('#teacherSubmitBtn').text('Update Teacher');
            window.scrollTo({top: 0, behavior: 'smooth'});
            window.removePicture = false;
        }

        function delRow(id) {
            if (!confirm('Delete this teacher?')) return;
            console.log('Deleting teacher ID:', id);
            $.ajax({
                url: `/teachers/delete/${id}`,
                method: 'DELETE',
                success: () => {
                    console.log('Teacher deleted successfully');
                    alert('Teacher deleted successfully!');
                    loadTeachers();
                },
                error: (xhr) => {
                    console.error('Delete failed:', xhr);
                    alert('Failed to delete teacher: ' + (xhr.responseText || 'Server error'));
                }
            });
        }

        function resetForm() {
            console.log('Resetting form');
            $('#teacherForm')[0].reset();
            $('#teacherId').val('');
            $('#teacherCourseId').val('');
            $('#teacherPassword').val('');
            $('#teacherPreview').attr('src', '').hide();
            $('#removeImage').hide();
            $('#teacherSubmitBtn').text('Add Teacher');
            window.removePicture = false;
        }

        function generatePassword() {
            console.log('Generating password...');
            $.get('/teachers/generate-password')
                .done(function(response) {
                    console.log('Password generated successfully');
                    $('#teacherPassword').val(response.password);
                    alert('Password generated: ' + response.password + '\n\nPlease save this password and share it with the teacher.');
                })
                .fail(function(xhr) {
                    console.error('Password generation failed:', xhr);
                    alert('Failed to generate password. Please try again.');
                });
        }

        // Additional validation on form submit
        $('#teacherForm').on('submit', function(e) {
            e.preventDefault();

            // Double-check password field exists and has value for new teachers
            const id = $('#teacherId').val();
            const password = $('#teacherPassword').val().trim();

            console.log('Form validation - ID:', id, 'Password:', password ? 'provided' : 'empty');

            if (!id && !password) {
                console.warn('Validation failed: New teacher requires password');
                $('#teacherPassword').focus().addClass('is-invalid');
                alert('Password is required when creating a new teacher!');
                return false;
            }

            // Remove validation styling
            $('#teacherPassword').removeClass('is-invalid');

            return true;
        });
    </script>
</head>
<body>
<nav>
    <ul>
        <li><a href="/dashboard.html">Dashboard</a></li>
        <li><a href="/students.html">Students</a></li>
        <li><a href="/teachers.html">Teachers</a></li>
        <li><a href="/courses.html">Courses</a></li>
        <li><a href="#" onclick="logout()">Logout</a></li>
    </ul>
</nav>
<main>
    <h2 id="pageTitle" class="mb-4">Manage Teachers</h2>
    <section id="insertBlock" class="d-none mb-4">
        <form id="teacherForm" class="p-3 border rounded bg-white shadow-sm">
            <div class="mb-3 text-center">
                <img id="teacherPreview" src="" alt="Preview" style="width:80px;height:80px;border-radius:50%;object-fit:cover;display:none;">
                <button type="button" id="removeImage" style="display:none; background:red; color:white; border:none; border-radius:50%; position:relative; top:-20px; left:-30px;">X</button>
            </div>
            <div class="mb-3">
                <label class="form-label">Profile Picture (JPG/PNG, ≤ 5 MB, optional)</label>
                <input id="teacherProfile" type="file" class="form-control" accept="image/jpeg,image/png">
            </div>
            <div class="row g-3">
                <div class="col-md-6">
                    <label class="form-label">Name *</label>
                    <input id="teacherName" type="text" class="form-control" placeholder="Full name" required>
                </div>
                <div class="col-md-6">
                    <label class="form-label">Email *</label>
                    <input id="teacherEmail" type="email" class="form-control" placeholder="email@site.com" required>
                </div>
                <div class="col-12">
                    <label class="form-label">Course *</label>
                    <input id="teacherCourseName" type="text" class="form-control" placeholder="Type to search course" required>
                    <input id="teacherCourseId" type="hidden">
                    <small class="form-text text-muted">Select from suggestions or type to match.</small>
                </div>
                <div class="col-12">
                    <label class="form-label">Password <span class="text-danger">*</span></label>
                    <div class="input-group">
                        <input id="teacherPassword" type="password" class="form-control" placeholder="Required for new teachers">
                        <button type="button" id="generatePasswordBtn" class="btn btn-outline-secondary">Generate</button>
                    </div>
                    <small class="form-text text-muted">
                        <strong>For new teachers:</strong> Password is required for login access.<br>
                        <strong>For updates:</strong> Leave blank to keep existing password, or enter new password to change it.
                    </small>
                </div>
            </div>
            <input id="teacherId" type="hidden">
            <div class="mt-3">
                <button id="teacherSubmitBtn" class="btn btn-primary me-2" type="submit">Add Teacher</button>
                <button type="button" class="btn btn-secondary" onclick="resetForm()">Cancel</button>
            </div>
        </form>
    </section>
    <div id="teacherGrid" class="ag-theme-alpine" style="height: 500px; width: 100%;"></div>
</main>
<footer>© 2025 Student Management System</footer>
</body>
</html>
