<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Student Management</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        table { border-collapse: collapse; width: 100%; margin-top: 20px; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: center; }
        th { background-color: #f2f2f2; }
        input, button { margin: 5px; padding: 5px; }
    </style>
</head>
<body>

<h2>Student Management</h2>

<form id="studentForm">
    <input type="hidden" id="roll" />
    <input type="text" id="name" placeholder="Name" required />
    <input type="email" id="email" placeholder="Email" required />
    <input type="number" id="age" placeholder="Age" required />
    <input type="text" id="course" placeholder="Course" required />
    <button type="submit" id="submitBtn">Add Student</button>
</form>

<button onclick="logout()">Logout</button>

<table>
    <thead>
    <tr>
        <th>Roll</th>
        <th>Name</th>
        <th>Email</th>
        <th>Age</th>
        <th>Course</th>
        <th>Actions</th>
    </tr>
    </thead>
    <tbody id="studentTable"></tbody>
</table>

<script>
    $(document).ready(function () {
        loadStudents();

        // Helper to check if response is likely login HTML
        function isLoginRedirect(response) {
            return typeof response === 'string' && response.includes('<html') && response.includes('login');
        }

        // Load Students
        function loadStudents() {
            $.get("/students/all", function (data) {
                let rows = "";
                data.forEach(student => {
                    rows += `
                        <tr>
                            <td>${student[0]}</td>
                            <td>${student[1]}</td>
                            <td>${student[2]}</td>
                            <td>${student[3]}</td>
                            <td>${student[4]}</td>
                            <td>
                                <button onclick="editStudent(${student[0]}, '${student[1]}', '${student[2]}', ${student[3]}, '${student[4]}')">Edit</button>
                                <button onclick="deleteStudent(${student[0]})">Delete</button>
                            </td>
                        </tr>`;
                });
                $("#studentTable").html(rows);
            }).fail(function (xhr) {
                if (xhr.status === 401 || xhr.status === 403 || isLoginRedirect(xhr.responseText)) {
                    alert("Session expired or access denied. Redirecting to login...");
                    window.location.href = "/login";
                } else {
                    alert("Error loading students: " + (xhr.responseText || "Unknown error"));
                }
            });
        }

        // Add or Update Student
        $("#studentForm").submit(function (event) {
            event.preventDefault();

            let studentData = {
                roll: $("#roll").val(),
                name: $("#name").val(),
                email: $("#email").val(),
                age: $("#age").val(),
                course: $("#course").val()
            };

            let url = studentData.roll ? "/students/update" : "/students/add";
            let method = studentData.roll ? "PUT" : "POST";

            $.ajax({
                type: method,
                url: url,
                contentType: "application/json",
                data: JSON.stringify(studentData),
                success: function (response) {
                    alert(response);
                    $("#studentForm")[0].reset();
                    $("#roll").val("");
                    $("#submitBtn").text("Add Student");
                    loadStudents();
                },
                error: function (xhr) {
                    if (xhr.status === 401 || xhr.status === 403 || isLoginRedirect(xhr.responseText)) {
                        alert("Access denied. Redirecting to login...");
                        window.location.href = "/login";
                    } else {
                        alert("Error: " + (xhr.responseText || "Unknown error"));
                    }
                }
            });
        });

        // Edit Student
        window.editStudent = function (roll, name, email, age, course) {
            $("#roll").val(roll);
            $("#name").val(name);
            $("#email").val(email);
            $("#age").val(age);
            $("#course").val(course);
            $("#submitBtn").text("Update Student");
        };

        // Delete Student
        window.deleteStudent = function (roll) {
            if (confirm("Are you sure you want to delete this student?")) {
                $.ajax({
                    type: "DELETE",
                    url: "/students/delete/" + roll,
                    success: function (response) {
                        alert(response);
                        loadStudents();
                    },
                    error: function (xhr) {
                        if (xhr.status === 401 || xhr.status === 403 || isLoginRedirect(xhr.responseText)) {
                            alert("Access denied. Redirecting to login...");
                            window.location.href = "/login";
                        } else {
                            alert("Error deleting: " + (xhr.responseText || "Unknown error"));
                        }
                    }
                });
            }
        };

        // Logout

        window.logout = function () {
            $.post("/logout")
                .always(function () {  // Handles both success and redirect 'failures'
                    window.location.href = "/login";
                });
        };
    });
</script>

</body>
</html>
